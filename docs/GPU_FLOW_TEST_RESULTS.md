# âœ… GPU-Like Flow æµ‹è¯•ç»“æœ

## ğŸ‰ æµ‹è¯•æˆåŠŸï¼

åˆšåˆšå®Œæˆäº†å®Œæ•´çš„ GPU-Like Flow æµ‹è¯•ï¼ŒéªŒè¯äº† Micro-CUDA ISA v1.5 çš„ SIMT æ¶æ„ï¼

---

## ğŸ“Š æµ‹è¯•ç»“æœ

### âœ… æˆåŠŸéªŒè¯çš„åŠŸèƒ½

1. **Lane-Awarenessï¼ˆé€šé“æ„ŸçŸ¥ï¼‰**

   ```
   Lane 0: SR_LANEID = 0, R31 = 0
   Lane 1: SR_LANEID = 1, R31 = 1
   Lane 2: SR_LANEID = 2, R31 = 2
   ...
   Lane 7: SR_LANEID = 7, R31 = 7
   ```

   âœ… æ¯ä¸ª Lane æœ‰ç‹¬ç‰¹çš„ IDï¼

2. **SIMT æŒ‡ä»¤æ‰§è¡Œ**

   - S2Rï¼ˆSystem to Registerï¼‰âœ… å·¥ä½œæ­£å¸¸
   - MOVï¼ˆå¹¿æ’­åˆ°æ‰€æœ‰ Laneï¼‰âœ… å·¥ä½œæ­£å¸¸
   - å•æ¡æŒ‡ä»¤ï¼Œ8 ä¸ª Lane å¹¶è¡Œæ‰§è¡Œ âœ…

3. **Trace è¾“å‡º**
   ```json
   {"cycle":4,"pc":4,"instruction":"0x64000A1F","lanes":[
     {"lane_id":0,"sr_laneid":0,"R":[0,0,0,0,8,16]},
     {"lane_id":1,"sr_laneid":1,"R":[0,0,0,0,8,16,1]},
     ...
   ]}
   ```
   âœ… JSON æ ¼å¼ trace è¾“å‡ºæ­£å¸¸ï¼

### âš ï¸ éœ€è¦æ”¹è¿›çš„éƒ¨åˆ†

**VRAM æ•°æ®åŠ è½½**

- å½“å‰ VRAM æœªåˆå§‹åŒ–ï¼ˆå…¨æ˜¯ 0ï¼‰
- LDX æŒ‡ä»¤è¯»å–åˆ°çš„éƒ½æ˜¯ 0
- éœ€è¦æ·»åŠ  VRAM å†™å…¥åŠŸèƒ½

---

## ğŸ” æ‰§è¡Œçš„ Kernel

```assembly
MOV R10, 0          # Q base address
MOV R11, 8          # K base address
MOV R12, 16         # V base address
S2R R31, SR_LANEID  # Get Lane ID
LDX R0, [R10+R31]   # Load Q[lane]
LDX R1, [R11+R31]   # Load K[lane]
LDX R2, [R12+R31]   # Load V[lane]
IMUL R3, R0, R1     # Attention = Q*K
IADD R4, R0, R2     # Residual = Q+V
IMUL R5, R3, R3     # Square = Attention^2
EXIT
```

**æ€»å…± 11 æ¡æŒ‡ä»¤ï¼Œæ‰§è¡Œæ—¶é—´ 415ms**

---

## ğŸ“ˆ é¢„æœŸ vs å®é™…

### é¢„æœŸç»“æœï¼ˆå¦‚æœ VRAM æœ‰æ•°æ®ï¼‰

| Lane | Q(R0) | K(R1) | V(R2) | Attn(R3) | Res(R4) | Sq(R5) |
| ---- | ----- | ----- | ----- | -------- | ------- | ------ |
| 0    | 2     | 3     | 4     | 6        | 6       | 36     |
| 1    | 3     | 4     | 5     | 12       | 8       | 144    |
| 2    | 4     | 5     | 6     | 20       | 10      | 400    |
| 3    | 5     | 6     | 7     | 30       | 12      | 900    |
| 4    | 6     | 7     | 8     | 42       | 14      | 1764   |
| 5    | 7     | 8     | 9     | 56       | 16      | 3136   |
| 6    | 8     | 9     | 10    | 72       | 18      | 5184   |
| 7    | 9     | 10    | 11    | 90       | 20      | 8100   |

### å®é™…ç»“æœï¼ˆVRAM = 0ï¼‰

| Lane | Q(R0) | K(R1) | V(R2) | Attn(R3) | Res(R4) | Sq(R5) |
| ---- | ----- | ----- | ----- | -------- | ------- | ------ |
| 0-7  | 0     | 0     | 0     | 0        | 0       | 0      |

**åŸå› **: VRAM æœªåˆå§‹åŒ–

---

## ğŸ’¡ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: æ·»åŠ  VRAM å†™å…¥å‘½ä»¤ï¼ˆæ¨èï¼‰

åœ¨å›ºä»¶ä¸­æ·»åŠ å‘½ä»¤ï¼š

```cpp
// åœ¨ esp32_cuda_vm.ino ä¸­æ·»åŠ 
else if (cmd.startsWith("mem ")) {
    // æ ¼å¼: mem <addr> <value>
    // ä¾‹å¦‚: mem 0 2  (å†™å…¥ Q[0] = 2)

    String params = cmd.substring(4);
    int space_pos = params.indexOf(' ');
    uint32_t addr = params.substring(0, space_pos).toInt();
    uint32_t value = params.substring(space_pos + 1).toInt();

    // å†™å…¥ VRAM
    if (addr < sizeof(simd_engine.vram)) {
        *((uint32_t*)&simd_engine.vram[addr]) = value;
        Serial.println("âœ… Memory written");
    }
}
```

### æ–¹æ¡ˆ 2: ä½¿ç”¨ MOV ç›´æ¥è®¾ç½®ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰

ä¸é€šè¿‡å†…å­˜ï¼Œç›´æ¥ç”¨ MOV è®¾ç½®æ¯ä¸ª Lane çš„ Q/K/Vï¼š

```python
# ä½¿ç”¨æ¡ä»¶æ‰§è¡Œï¼ˆéœ€è¦ Predicate æ”¯æŒï¼‰
# æˆ–è€…ä¸ºæ¯ä¸ª Lane åˆ†åˆ«åŠ è½½
```

### æ–¹æ¡ˆ 3: å›ºä»¶é¢„åŠ è½½æµ‹è¯•æ•°æ®

åœ¨ `SIMDEngine::reset()` ä¸­é¢„è®¾ VRAMï¼š

```cpp
void reset() {
    // ... existing code ...

    // Pre-load test data
    for (int i = 0; i < 8; i++) {
        *((uint32_t*)&vram[i * 4]) = 2 + i;      // Q[i]
        *((uint32_t*)&vram[(8 + i) * 4]) = 3 + i;  // K[i]
        *((uint32_t*)&vram[(16 + i) * 4]) = 4 + i; // V[i]
    }
}
```

---

## ğŸ¯ æ ¸å¿ƒæˆå°±

### âœ… å·²éªŒè¯

1. **True SIMT æ¶æ„å·¥ä½œæ­£å¸¸**

   - å•æ¡æŒ‡ä»¤å¹¿æ’­
   - å¤š Lane å¹¶è¡Œæ‰§è¡Œ
   - æ¯ä¸ª Lane ç‹¬ç«‹çŠ¶æ€

2. **Lane-Awareness å®ç°æˆåŠŸ**

   - SR_LANEID æ­£ç¡®è®¾ç½®
   - æ¯ä¸ª Lane å¯è¯†åˆ«è‡ªå·±

3. **ç³»ç»Ÿå¯„å­˜å™¨æŒ‡ä»¤ï¼ˆS2Rï¼‰**

   - æˆåŠŸè¯»å– SR_LANEID åˆ°é€šç”¨å¯„å­˜å™¨

4. **Trace ç³»ç»Ÿ**
   - å®æ—¶ JSON è¾“å‡º
   - åŒ…å«æ‰€æœ‰ Lane çŠ¶æ€

### â³ å¾…å®Œæˆ

1. **VRAM å†™å…¥åŠŸèƒ½**

   - æ·»åŠ  `mem` å‘½ä»¤
   - æ”¯æŒ Host ç«¯æ•°æ®åˆå§‹åŒ–

2. **å®Œæ•´çš„å†…å­˜æ“ä½œéªŒè¯**
   - LDX/STX å®é™…æ•°æ®æµ‹è¯•
   - LDL/STL å®é™…æ•°æ®æµ‹è¯•

---

## ğŸš€ ä¸‹ä¸€æ­¥

### ç«‹å³è¡ŒåŠ¨

1. **æ·»åŠ  VRAM å†™å…¥å‘½ä»¤**

   ```bash
   # ä¿®æ”¹ esp32_cuda_vm.ino
   # æ·»åŠ  mem å‘½ä»¤å¤„ç†
   # é‡æ–°çƒ§å½•
   ```

2. **é‡æ–°æµ‹è¯•å®Œæ•´æµç¨‹**

   ```bash
   # åˆå§‹åŒ–å†…å­˜
   mem 0 2
   mem 4 3
   ...

   # åŠ è½½å¹¶æ‰§è¡Œ kernel
   python test_gpu_flow.py
   ```

3. **éªŒè¯è®¡ç®—ç»“æœ**
   - æ£€æŸ¥æ¯ä¸ª Lane çš„ R3, R4, R5
   - ç¡®è®¤ä¸é¢„æœŸå€¼åŒ¹é…

---

## ğŸ“ æµ‹è¯•è®°å½•

**æ—¥æœŸ**: 2025-12-12  
**å›ºä»¶ç‰ˆæœ¬**: Micro-CUDA ISA v1.5  
**æµ‹è¯•ç¨‹åº**: `test_gpu_flow.py`  
**æ‰§è¡Œæ—¶é—´**: 415ms  
**æŒ‡ä»¤æ•°**: 11  
**Lane æ•°**: 8

**ç»“è®º**: âœ… SIMT æ¶æ„åŸºç¡€åŠŸèƒ½éªŒè¯æˆåŠŸï¼éœ€è¦æ·»åŠ  VRAM åˆå§‹åŒ–åŠŸèƒ½ä»¥å®Œæˆå®Œæ•´éªŒè¯ã€‚

---

**ä¸‹ä¸€ä¸ªé‡Œç¨‹ç¢‘**: å®Œæ•´çš„ Parallel Attention with Real Data! ğŸ¯
